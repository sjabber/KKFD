<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/joinlist.css" />
  <link rel="stylesheet" type="text/css" href="/css/public.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
    crossorigin="anonymous"></script>
  <title>크크펀딩</title>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    function searchParam(key) {
      return new URLSearchParams(location.search).get(key);
    }

    //운송장번호 자릿수제한(input type number)
    function numberMaxLength(e) {
      if (e.value.length > e.maxLength) {
        e.value = e.value.slice(0, e.maxLength);
      }
    };
    //천단위 쉼표
    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };
    //var optionHtml = '<option value="">--선택--</option>' + '<option value="1">대한통운</option>' + '<option value="2">우체국</option>' + '<option value="3">한진택배</option>' + '<option value="4">현대택배</option>';
    $(function () {
      const URLSearch = new URLSearchParams(location.search);
      var projNo = searchParam("no");
      var trHtml = '';
      var backurl = "http://localhost:9999/kkfd/project/" + projNo + "/fundings";
      $.ajax({
        "method": "GET",
        "url": backurl,
        "transformRequest": [null],
        "transformResponse": [null],
        "jsonpCallbackParam": "callback",
        "headers": {
          "Accept": "application/json, text/plain, */*"
        },
        "timeout": {},
        success: function (responseObj) {
          $(responseObj).each(function (i, f) {
            var track = f.funTrack;
            trHtml += '<tr>'
            trHtml += '<th scope="row">';
            //if(trackNo==null){ //운송장 입력 기능 활성화되면 교체
            if (track == 0) {
              trHtml += '<input type="checkbox" name="funNo" class="funNo form-check-input"  value="';
              trHtml += f.funNo;
              trHtml += '">'
            }
            trHtml += '</th>';
            trHtml += '<td class="text-center">';
            trHtml += f.funNo;
            trHtml += '</td>';
            trHtml += '<td>';
            trHtml += f.funDate;
            trHtml += '</td>';
            trHtml += '<td class="text-center">';
            trHtml += f.member.memName;
            trHtml += '</td>';
            trHtml += '<td>';
            trHtml += f.member.memPhone;
            trHtml += '</td>';
            trHtml += '<td class="addr"><input class="addr form-control" title="복사하려면 클릭하세요" type="text" disabled value="';
            trHtml += f.funAddress + " ";
            trHtml += f.funDetail;
            trHtml += '"/>';
            trHtml += '</td>';
            trHtml += '<td class="text-center">';
            trHtml += f.funQuantity;
            trHtml += '</td>';
            /*택배사 추가시 살리기
            trHtml += '<td class="text-center">'

            if (track == 0) {
              trHtml += '<select class="trackIn form-control form-control-sm" name ="courier" disabled required>';
              trHtml += optionHtml;
              trHtml += '</select>';
            } else {
              trHtml += "택배사";
            }
            trHtml += '</td>';
            */
            trHtml += '<td class="text-center">';
            if (track == 0) {
              trHtml += '<input class="trackIn form-control form-control-sm" type="number" name=trackNum" disabled required placeholder="대한통운 12자리" maxlength="12" oninput="numberMaxLength(this);"/>';
            } else {
              trHtml += track;
            }
            trHtml += '</td>';
            trHtml += '</tr>';
          });//end of each
          $('#tableBody').html(trHtml);

          //프로젝트 정보 제목, 모집금액, 달성률, 종료일, 배송예정일
          var p = responseObj[0].project;
          var totalFm = p.projFm * p.projQuantity;
          $('div.proj_title').html(p.projTitle);
          $('div.pct > span.fm').html(numberWithCommas(totalFm) + '원');
          $('div.pct > span.goal_pct').html(p.projGoals + '%');
          $('div.day > span.end').html(p.projEnd);
          $('div.day > span.delivery').html(p.projDelivery);

        },//end of success
        error: function (jqXHR, textStatus) {

        }//end of error
      });//end of Ajax

      $('button.track').click(function () {
        //(부가기능)12자리 유효성 검사~
        //체크박스 선택된 행의 펀딩번호,운송장 번호 JSON으로 변환
        var jsonArr = new Array();
        $('input[name=funNo]:checked').each(function () {
          var $trObj = $(this).parent().parent();
          var $inputObj = $trObj.children().eq(7).find('input.trackIn');
          var value = $inputObj.val();
          if (value.length < 12) {
            return false;
          }
          var funObj = new Object();//초기화
          funObj["funNo"] = $(this).val();
          funObj["funTrack"] = $inputObj.val();
          /*배송 테이블,DTO만들어지면 변수명 바꾸기
          trackObj["delFun"] = $(this).val();
          trackObj["delCourier"] = $(this).val();
          trackObj["delTrack"] = $(this).val();*/
          jsonArr.push(funObj);
        });
        var data = JSON.stringify(jsonArr);
        console.log(data);
        var backurl = "http://localhost:9999/kkfd/fundings";
        $.ajax({
          "method": "PUT",
          "url": backurl,
          "transformRequest": [null],
          "transformResponse": [null],
          "jsonpCallbackParam": "callback",
          "headers": {
            "Accept": "application/json, text/plain, */*",
            "Content-Type": "application/json;charset=utf-8"
          },
          "data": data,
          "timeout": {},
          success: function (responseData) {
            alert(responseData + "건 운송장 입력 완료");
            location.reload();

          },
          error: function (jqXHR, textStatus) {

          }

        });

      });

      //검색
      $("#mykeyword").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#tableBody tr").filter(function () {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });


      //체크박스 클릭시 tr테두리
      $('#tableBody').on('change', 'input.funNo', function () {
        var $trObj = $(this).parent().parent();
        //$selectObj = $trObj.children().eq(7).find('select.trackIn');
        $inputObj = $trObj.children().eq(7).find('input.trackIn');
        $trObj.toggleClass("border").toggleClass("border-danger");
        if ($(this).is(":checked") == true) {
          //$selectObj.attr("disabled", false);
          $inputObj.attr("disabled", false);
        } else {
          //$selectObj.attr("disabled", true);
          $inputObj.attr("disabled", true);
        }
      });

      //운송장 번호 입력시 파란색으로 표시
      $('#tableBody').on('change', 'input.trackIn', function () {
        var $trObj = $(this).parent();
        if ($(this).val() == 0) {
          $trObj.addClass("border-danger");
          $trObj.removeClass("border-info");
        } else {
          $trObj.removeClass("border-danger");
          $trObj.addClass("border-info");
        }
      });
      //주소 셀선택시 복사(왜안됨?ㅠ)
      $('#tableBody').on('click', 'td.addr>input.addr', function () {
        var $trObj = $(this).parent().parent();
        var name = $trObj.children().eq(3).html();
        this.select();
        document.execCommand('copy');
        alert(name + '님의 주소 복사 완료');
      });
    });
  </script>
</head>

<body>
  <!-- header -->
  <header class="main_header">
    <div class="main_header_warp">
      <div class="header_menu_warp">
        <div class="header_projectsearch">
          <button class="projectsearch_item">
            <a style="text-decoration: none; color: black" href="/project/list/">
              <i class="fas fa-align-justify fa-lg"></i>
              <span class="projectsearch_name">프로젝트 둘러보기</span>
            </a>
          </button>
        </div>
        <div class="header_projectupload">
          <a style="text-decoration: none;" href="/register/registerAgree/">
            <span class="projectupload_name">프로젝트 올리기</span>
          </a>
        </div>
      </div>
      <div class="header_mainlogo">
        <a style="text-decoration: none;" href="/">
          <span class="header_mainlogo_item">크크펀딩</span>
        </a>
      </div>
      <div class="header_sub_warp">
        <div class="header_searchicon">
          <!-- <i class="fas fa-search fa-lg"></i> -->
        </div>
        <div class="header_customer_warp">
          <button class="header_customer_btn">
            <div class="header_login&signup">
              <span class="login&signup_name">
                <a href="/member/login">로그인 / 회원가입</a>
              </span>
            </div>
            <div class="header_profile_img">
              <img class="profile" src="/img/blank.png">
            </div>
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- 메인섹션 -->
  <section class="main_section">
    <div class="my">
      <div class="proj_wrap">
        <div class="represent_img">
          <img class="thumbnail_img" src="/img/1_0.png" />
          <!--fun_proj + '_o.png'-->

        </div>
        <div class="prev_proj_info_wrap">
          <div class="proj_title">
            프로젝트 타이틀
          </div>
          <div class="pct">
            <span class="fm fs-5">
              <!-- 모인 금액 -->
            </span>
            <span class="goal_pct fw-bold text-danger">
              <!-- 달성률 -->
            </span>
          </div>
          <div class="day ">
            <span class="fw-bold"> 종료일 :</span>
            <span class="end me-2">
              <!-- 종료일 -->
            </span>
            <span class="fw-bold">
              배송예정일 :
            </span>
            <span class="delivery fw-bold text-danger">
              <!-- 달성률 -->
            </span>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="d-flex justify-content-between align-items-baseline m-3">
          <input id="mykeyword" type="text" placeholder="검색">
          <button type="button" class="track btn btn-danger">운송장 입력</button>
        </div>
        <div class="table-wrapper-scroll-y my-custom-scrollbar">
          <table class="joinerlist table table-borderless table-striped">
            <thead>
              <tr class="bg-light">
                <!--
                <th scope="col" width="3%"></th>
                <th scope="col" width="9%" class="text-center fw-bold">펀딩번호</th>
                <th scope="col" width="10%" class="text-center fw-bold">신청일시</th>
                <th scope="col" width="10%" class="text-center fw-bold">이 름</th>
                <th scope="col" width="15%" class="text-center fw-bold">연락처</th>
                <th scope="col" width="21%" class="text-center fw-bold">Email</th>
                <th scope="col" width="6%" class="text-center fw-bold">수량</th>
                <th scope="col" width="9%" class="text-center fw-bold ">택배사</th>
                <th scope="col" width="13%" class="text-center fw-bold ">운송장입력</th>-->
                <th scope="col" width="4%"></th>
                <th scope="col" width="8%" class="text-center fw-bold">펀딩번호</th>
                <th scope="col" width="8%" class="text-center fw-bold">신청일시</th>
                <th scope="col" width="10%" class="text-center fw-bold">이 름</th>
                <th scope="col" width="13%" class="text-center fw-bold">연락처</th>
                <th scope="col" width="37%" class="text-center fw-bold">주소</th>
                <th scope="col" width="6%" class="text-center fw-bold">수량</th>
                <th scope="col" width="13%" class="text-center fw-bold ">운송장입력</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!--펀딩 참여자 추가-->
            </tbody>
          </table>

        </div>

      </div>
      <div class="d-flex justify-content-end m-3">
        <button type="button" class="track btn btn-danger">운송장 입력</button>
      </div>
    </div>


  </section>
  <footer class="main_footer">

    <div class="footer_second_warp">
      <div class="footer_info_warp">
        <div class="info_first_warp">
          <span class="info_item1">회사명</span>
          <span class="info_item2">크크펀딩</span>
          <span class="info_item1">주소</span>
          <span class="info_item2">경기도 성남시 분당구 성남대로 34 6층(구미동 하나프라자빌딩)</span>
          <span class="info_item1">대표</span>
          <span class="info_item2">오문정</span>
          <span class="info_item1">사업자등록번호</span>
          <span class="info_item2">105-87-52823</span>
        </div>
        <div class="info_second_warp">
          <span class="info_item1">통신판매업 신고번호</span>
          <span class="info_item2">2019-3010165-30-2-02129</span>
          <span class="info_item1">대표번호</span>
          <span class="info_item2">031-606-9319</span>
        </div>
        <div class="info_last_warp">
          <span class="last_warp_item">© 2021 KKPD Inc.</span>
        </div>
      </div>
      <div class="footer_info_icon">
        <i class="fab fa-java fa-lg"></i>
        <i class="fab fa-js fa-lg"></i>
        <i class="fab fa-html5 fa-lg"></i>
        <i class="fab fa-css3 fa-lg"></i>
        <i class="fas fa-user-md fa-lg"></i>
        <i class="fas fa-head-side-mask fa-lg"></i>
      </div>
    </div>
    <div class="footer_last_info">
      <div class="footer_last_info_div">
        <span class="last_info_item">
          크크펀딩은 플랫폼 제공자로서 프로젝트의 당사자가 아니며, 직접적인 통신판매를 진행하지 않습니다. 프로젝트의 완수 및 선물제공의 책임은 해당 프로젝트의 창작자에게 있으며, 프로젝트와 관련하여 후원자와
          발생하는 법적 분쟁에 대한 책임은 해당 창작자가 부담합니다.
        </span>
      </div>
    </div>
  </footer>

</body>

</html>